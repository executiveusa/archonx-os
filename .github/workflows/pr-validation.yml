name: PR Validation & Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check PR title format
        run: |
          if [[ ! "${{ github.event.pull_request.title }}" =~ ^(feat|fix|docs|refactor|test|chore):.+ ]]; then
            echo "PR title must start with: feat:|fix:|docs:|refactor:|test:|chore:"
            exit 1
          fi
      
      - name: Check for conflicts
        run: |
          git fetch origin main
          git merge-base --is-ancestor origin/main HEAD || {
            echo "PR has merge conflicts"
            exit 1
          }
      
      - name: Require tests for code changes
        run: |
          if git diff --name-only origin/main | grep -q "^archonx/"; then
            if ! git diff --name-only origin/main | grep -q "^tests/"; then
              echo "Code changes require corresponding tests"
              exit 1
            fi
          fi
  
  auto-merge:
    needs: [validate]
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]' || contains(github.event.pull_request.labels.*.name, 'automerge')
    steps:
      - name: Auto-merge
        uses: pascalgn/automerge-action@v0.16.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_METHOD: squash
          MERGE_COMMIT_MESSAGE: pull-request-title
          MERGE_RETRIES: 6
          MERGE_RETRY_SLEEP: 10000
